---
layout: post
permalink: /blog/programming-based-on-data-and-pipe.html
title: "基于数据和管道的编程"
category: articles
tags: [Jekyll]
---

    kiterunner_t
    TO THE HAPPY FEW


通常，当面对一个中大型项目的时候，系统的复杂性不在于多高深的算法，而在与复杂的业务逻辑随着时间的变迁，日渐复杂，系统间的耦合性越来越大，维护与新特性的开发也日益艰难。不管我们使用的是何种开发语言（过程式或对象式），这种复杂性和耦合性多半来源于子系统的分解不合理，更多的是来自一种非常直观的命令式分解。

在UNIX或类UNIX系统上，Shell中最有用的莫过于子程序和管道。让我们看看该模式，如下代码所示。这实际上就是以数据为核心，通过管道的方式进行数据流的处理。而在数据划分的过程中，可以充分借鉴企业开发中数据库的观点，以数据为驱动进行程序的开发（本文不具体讨论这一点）。

    cat test.txt | sed "s/aa/bb/" | grep "bb"


对于该模型，最显而易见的优点是，系统被分解为更小的子系统了，更易理解、开发和维护。其次，可以随意的数据流动的方向上插入新的管道，对数据流进行新的处理。再次，在编程的时候，可以很容易的将功能性代码和非功能性代码区分开，不需要每次开发新特性的时候，都需要写诸如内存消耗统计、CPU统计、中间数据状态统计等有助于分析系统行为和调试的非功能特性等等。

这里，我选择两个实际中的案例讨论下这种模型在编程中的应用。通过数据和管道的分解，我们就更能清晰的了解每个子模块的边界、系统的结构等。

## 1 消息文件解析问题

### 1.1 问题描述

假设有2种消息文件fileA和fileB，文件中二进制消息格式不同，但都由一条一条的记录组成。有一个外部文件desc描述了这两种消息文件的具体格式。我们需要写一个程序将两个消息文件解析成格式化的txt或csv文件，并且可能需要对消息进行过滤、归类等。

每条记录都会有消息id、发送者、接收者这三个字段，过滤和归类可能只需要解析某种类型的消息id，或者按照消息接收者分别存储到不同文件等。后续也可能加入更多的需求。

### 1.2 现状

该项目现有实现中，使用Python开发，代码量也过万行。基本没有进行任何的拆分，可能由于解析描述消息的的文件desc的解析是借鉴自其他模块，子模块边界还算清楚，其他模块完全耦合在一块，一遍从文件中读出记录，一边解析，一边输出。还未加入过滤、归纳等功能。

由于耦合在一块，代码不易理解，不易扩展，若要加入一些非功能性代码对程序自身进行profile的时候，也会自然的耦合到一块。

### 1.3 数据和管道分解

由于这里的数据模型是非常清楚的，在分析过程中，基本不用对数据进行过多讨论，各个管道的消息边界很容易界定。从应用场景来看，程序中的数据可以简单分为以下：

* 二进制记录messageBin
* 解析后的消息Message

    class Message():
      def __init__(self):
        self.id = ""
        self.sender = ""
        self.receiver = ""
        # others field


* 解析消息的描述MessageDesc

    class MessageDesc():
      def __init__(self):
        self.id = ""
        self.size = 0
        self.isDynamic = False # 消息长度是否可变
        self.fields = []       # 字段描述，存的是MessageField
        self.formatStr = ""
    
    class MessageField():
      def __init__(self):
        self.name = ""  # 字段名字
        self.type = ""  # 字段类型
        self.index = 0  # 字段在消息字段中的索引
        self.size = 0   # 字段大小
        self.offset = 0 # 字段偏移量


数据及其流动的管道图示如下：

![message-decoder-data-and-pipe][1]

## 2 资源调度问题

@TODO

在前一个问题中，无论是数据本身还是管道，都有比较清晰的界定。而在更多的程序开发中，并没有那么清晰的界定。因此需要更多的分析和考虑，而当我们从数据和管道的角度去考虑程序的分解时，可以充分利用企业开发中的数据库中数据设计一些经验。

### 2.1 问题描述


### 2.2 现状


### 2.3 数据和管道分解


[1]: /images/message-decoder-data-and-pipe.jpg "message-decoder-data-and-pipe"

